<link rel="stylesheet" type="text/css" href="../auto-number-title.css" />

# QLCP-2021A 使用手册

| 版本 | 作者 | 说明 |
|----|----|----|
| 210404 | 小林博士 | 初始版本 |

[toc]

## 概述

QLCP-2021A = Quick Light Curve Pipeline, Version Jan 2021

本程序基于Python3开发，用于从赤道式望远镜观测的非密集星场中变源的光变曲线提取。

### 处理能力

+ 本版本程序针对没有场旋的赤道式望远镜观测图像设计。
+ 对于地平式望远镜，若通过消旋器控制可以实现观测全过程视场方向基本不变，也可以处理。
+ 如果有场旋，请等待下一版本。
+ 对于望远镜观测中发生的微小视场漂移，本程序可以自动解决。（微小：特指目标星和参考星、校验星等并未脱离视场范围）
+ 对于视场畸变，在视场较小的情况下，不影响本程序处理。
+ 如果缺失当天的bias或者flat，请自行选取近期数据使用；若近期也没有数据，本程序可以处理，但是无法确保精度。
+ 对于密集星场，无法保障处理结果以及精度。此处密集，特指已经出现星像重叠的情况。
+ 本程序调用Source-Extractor (Bertin et al 2008）进行找源和测光，可以通过调整该程序的参数对测光过程进行控制。
+ 如果需要使用其它测光程序，可以自行测光，也可以等本程序后续版本进行多种方式的测光。
+ 本程序针对一个晚上的观测数据进行自动处理，若要合并多个晚上数据，需要手工进行。

### 网络问题

由于`astropy`包需要连接境外服务器同步日心实时运动等数据，很难连通，每个步骤执行时都会等待网络连接。为避免此问题，需要在调用前禁用自动更新。

```
from astropy.utils import iers
iers.conf.auto_download = False
```

禁用后在运行时将得到警报称使用历史数据进行插值，可能有误差。该误差主要在计算BJD和HJD时发生，如果确实需要提高精度，请自行设法联网下载实时数据。

## 安装以及需求包

Python版本：3.5-3.8，3.5以下和3.9以及以上未经测试。Python2无法执行。Windows下的Python3理论上可以执行除测光外的其它步骤（因为需要调用Source-Extractor），但是未经测试。

需要调用Source-Extractor进行测光，需要安装该软件。在Linux系统上可以使用`yum`、`apt-get`等系统包管理工具安装，对于macOS的早期版本，可以先安装`MacPorts`或`brew`进行安装，较新版本，可以参考网址：<br/>
`https://anaconda.org/conda-forge/astromatic-source-extractor`。
<br>Windows下未经测试，无法确定在WSL下是否可以安装并正常使用。

Python引用的程序包：
`os`,
`sys`,
`numpy`,
`scipy`,
`re`,
`astropy`,
`matplotlib`。

以上程序包并没有特定版本要求，越高越好。可以使用`pip`安装，或者用`conda`安装，根据各自安装Python的方式而定。

## 引入

在Python3以及相关包安装好之后，下载本程序即可。建议将本程序放在独立的路径中。以下假设程序放在`/home/data/pipeline/`下，程序本身目录名称为`qlcp21a`。

以下均假设程序在`jupyter notebook`或`jupyter-lab`中运行。

```
import sys
sys.path.append("/home/data/pipeline/")
import qlcp21a
```

## 基本参数说明

本程序运行，需要提供以下基本信息

### 观测数据信息

1. 原始数据所在目录，其内部直接存放观测原始数据，包括当天的本底、平场、科学数据等。至于该目录应该怎样命名，原始数据如何归档等，本程序不做要求。
1. 列表目录，用于存放自动生成的数据列表。可以将不同天的列表存放于同一个目录下，也可以每天分开存放，不影响程序处理。
1. 处理结果存放目录，建议和原始观测数据分开存放，避免管理混乱，非要放一起也不影响程序处理。注意留出必要的磁盘空间，通常为原始数据大小的2倍。

### 数据目录示例

以下假设各类数据保存于以下路径。注意：路径命名等根据个人习惯进行，没有任何限制，但是建议原始数据和处理结果分离。

+ 原始数据：`/home/data/raw/20210212_60/`
+ 文件列表：`/home/data/lst/20210212_60/`
+ 处理结果：`/home/data/red/20210212_60/`

### 观测设备信息

以下信息和观测设备有关，通常在同一台望远镜观测得到的数据，这三个项目信息是一致的，填入配置文件即可。

1. 在观测文件名中，应包括观测目标名称、波段、观测序列号等信息，以便程序自动识别。如果文件名无法体现这些信息，那么处理方式1：手动建立文件列表，2：将数据文件改名为符合要求的文件名模式。
1. 在fits文件头中，应能获取到观测时间(UTC)，至少精确到秒。时间和日期可以在同一个关键字，也可以在不同的关键字。
1. 在fits文件头中，应有目标的RA、Dec，如果没有，那么必须在调用时指定坐标。
1. 观测站所在地理位置，经度、纬度、海拔等，但是不要求很精确。

### 文件名和部分配置信息示例

假设使用兴隆观测基地60厘米望远镜数据，文件名例子为`J1836+3847_V_0123.fit`，其中`J1836+3847`为目标名，`V`为波段，`0123`为序号。fits头中`DATE-OBS`关键字表示观测日期和时间，格式为`'2021-02-12T12:34:56'`。在当前目录下建立配置文件`xl60.ini`，并写入如下信息：

```
site_lon = 117.57722  # 117:34:38      # 兴隆观测站的经度
site_lat = 40.395833  # +40:23:45      # 兴隆观测站的纬度
site_ele = 960                         # 兴隆观测站的高度
date_key   = "DATE-OBS"    # 观测日期头文件关键字
date_start = 0             # 开始字符
date_end   = 10            # 结束字符
time_key   = "DATE-OBS"    # 观测时间头文件关键字
time_start = 11            # 开始字符
time_end   = 19            # 结束字符
filename_temp = "(?P<obj>[^_]*)_(?P<band>[a-zA-Z]{0,1})_
(?P<sn>[0-9]{4}).fit"  # 文件名模板
```

*最后一个项目的换行，是为了便于阅读，实际应在一行内完成。*

## 快速调用

### 调用

```
qlcp21a.do_all(
    ini_file="xl60.ini", 
    raw_dir="/home/data/raw/20210212_60/",
    lst_dir="/home/data/lst/20210212_60/", 
    red_dir="/home/data/red/20210212_60/",
    steps="lbfipocdg",
)
```

以上只要提供额外配置文件、原始数据目录、列表目录、处理结果目、目标星坐标、操作步骤等，即可自动完成全部工作。

其中，目标星坐标是为了进行JD到BJD之间的转换，可以是目标坐标，也可以是图像中心坐标，差异并不大。后续会增加对HJD的计算。如果不提供，那么将不计算BJD/HJD，并且最终出图为JD。

### 局限性

以上调用法，将自动从观测文件名中提取目标信息、波段信息，并对所有目标进行依次处理。同时将从数据中自动猜测目标星，选择参考星。目标星选择原则是图像中信噪比较好，在全部观测数据中亮度变幅较大的目标，参考星的原则则是信噪比好且变化最小的星。绘图时，自动根据光变幅度等设置绘图参数。

如果图像中有其他变星，并且变幅超过目标星，可能会导致误判。如果目标星太暗，信噪比太低，也可能在自动猜测时被直接忽略。这种情况，需要指定目标星的位置。

自动选择的参考星，只考虑在当天的数据中的稳定性，不代表在多天的数据合并时的长期稳定性。典型的例子是长周期系外行星或者双星，在非掩食阶段基本上没有光变，但是长期来看不适合作为参考星。自动选择的参考星仅供参考。

## 调用参数说明

以上调用仅包括必须的信息，本节对参数进行逐一介绍。并举例说明用法。可选参数在标题中包括了默认值。

### `ini_file`

配置文件名。通常情况下，会按照以下顺序加载配置文件：

1. 程序所在路径的`default.ini`，这个文件中包含了所有必须的字段，以及作者选定的默认值
1. 执行时路径的`default.ini`，进行一些个性化啊的、通用的设置
1. 本参数指定的配置文件（如`xl60.ini`），用于针对性地进行配置
1. 通过后面的`extra_config`参数指定的配置项

以上配置文件，如果涉及到同一个配置项，越往后优先级越高。一般第一个中放置的是作者给出的默认值，第二个给出数据处理人员的常用值，第三个根据站点、望远镜等给出具体参数。

如果不想给出自定义配置文件，可以设置本参数为None或者空字符串、空列表等。

### `raw_dir`

原始数据所在路径，必选参数。所有路径，都可以是相对路径或绝对路径，能访问即可。

### `lst_dir`

列表文件所在路径，必选。

自动生成的列表文件名见文件名格式要求。特别地，在上面的命名示例中，不同日期、不同望远镜的列表文件将分开存放，如果希望将不同日期列表放在同一个目录下，但是每个文件名有相应的前缀，那么也可以用如下方式提供参数

`lst_dir="/home/data/lst/20210212_60_", `

如果不以`/`结尾，那么最后一段将是文件名前缀而非目录名。

如果提供的是目录名，并且目录未创建，会自动创建。

### `red_dir`

处理结果所在路径，必选。

如果本参数只给出路径，结尾不是`/`，本程序会自动加上`/`。必要时会自动创建路径以及下级路径。

**以上为必选参数，不可缺省。以下部分为可选参数，根据出场顺序以及重要性分别介绍。**

### `steps="lbfipocdg"`

本次要操作的步骤，每个字母代表一个步骤。可以任意选定步骤，通常为全部执行，或者每次执行其中一步或者连续的几步。但是原则上不建议跳过步骤。

**各步骤简介**

+ `l` (**L**ist)：<br>
本步骤为自动列表，自动根据给定的文件名模板去解析原始数据目录中的文件名，生成列表。如果下面的`obj, band`参数为空，那么就解析全部模板和波段，否则只解析指定内容。<br>
如果`steps`参数包括本步骤，那么`do_all`函数将返回生成的列表信息，可以保存在变量中供后续使用。<br>
自动生成的列表将包括所有满足文件名规则的文件，如果其中有部分文件被判定为数据不好，可以手工从列表中剔除，但是不建议删除原始文件。原始文件作为观测原始记录，应当原样保存。
+ `b` (**B**ias combine)：<br>
本底合并。对本底列表中指定的本底文件进行中值合并。
+ `f` (**F**lat combine)：<br>
平场合并。分波段进行，将平场原始文件减去合并的本底，随后每一幅图像根据中值进行归一化，最后逐个像元取中值，得到合并后的平场。
+ `i` (**I**mage correction)：<br>
科学图像的平场本底改正。原始图像进行减本底除平场。由于目前大部分望远镜都不再需要进行暗流改正，因此本程序未考虑暗流处理步骤。<br>
本步骤还根据观测时间字符串，计算了观测时的JD、BJD、HJD（暂时为空）等信息，保存于fits header中。
+ `p` (**P**hotometry)：<br>
逐幅图像进行测光，调用Source-Extractor。输出结果包括SE自己的星表格式，以及本程序转换后的格式，自己的格式包括fits表格版本和文本版本。
+ `o` (**O**ffset)：<br>
在测光找星基础上，进行图像对齐，给出各图相对指定图像的像元位移量。本程序不对图像进行裁剪。<br>
本程序暂时不对图像进行旋转改正处理，也暂时不进行天测处理，后续版本将加入该步骤。
+ `k` (pic**K** stars)：<br>
本步骤为隐藏步骤，未在上面的例子中列出。本步骤可以单独执行，用于从数据中猜测目标星和参考星，并且返回找到的星的坐标，供用户选用。如果指定了`c`步骤但是未指定目标坐标，如前例，也会自动调用本步骤进行猜测。
+ `c` (**C**atalog extract)：<br>
抽取出目标星和参考星的仪器星等，生成星表。本步骤要求提供目标星和参考星的xy坐标，将在给定坐标附近从各幅图像测光结果中找星，此处会根据图像之间的偏移量，正确计算给定坐标在不同图像上的对应位置。对于个别测光有问题的图像，可能出现在指定位置找不到星或者匹配到多颗星的情况。<br>
输出格式分为3种，fits表格、横向文本（每幅图像一行，每颗星依次排列）、纵向表格（每颗星一行）。<br>
注意，本步骤只负责提取仪器星等，不负责进行较差星等计算。在后续的较差分析中，可以自行编程读取数据进行，也可以从提取的列表中对目标进行筛选。此外，这里的提取操作，不区分目标星、参考星、校验星，因此可以提取多颗目标星和校验星。
+ `d` (**D**ifferential calibration)：<br>
利用参考星对目标星和校验星进行较差定标并保存较差结果。在`c`步骤中可以提取多颗星的星等，在本步骤可以进行筛选。
+ `g` (draw **G**raph)：<br>
利用较差定标结果绘制光变曲线图。

### 建议的步骤方式

如果数据基本上正常，可以一次性使用全部步骤，即`steps="lbfipocdg"`。特别说明：提供步骤时只要在该字符串中有对应字母即可，给出的顺序不影响执行顺序，不在步骤代码中的字符不影响操作。

如果希望逐步查看结果或者考虑对逐个步骤的参数进行优化，可以每次执行一个步骤，即每次只给出一个字母代码。建议第一次调用`"l"`，并保存结果，后续使用该结果指定目标。

```
bandobj = qlcp21a.do_all(
    ini_file="xl60.ini", 
    raw_dir="/home/data/raw/20210212_60/",
    lst_dir="/home/data/lst/20210212_60/", 
    red_dir="/home/data/red/20210212_60/",
    steps="l",  # 生成列表并返回列表信息
)
qlcp21a.do_all(
    ini_file="xl60.ini", 
    raw_dir="/home/data/raw/20210212_60/",
    lst_dir="/home/data/lst/20210212_60/", 
    red_dir="/home/data/red/20210212_60/",
    bandobj=bandobj,  # 使用此前生成的列表信息
    steps="bf",  # 可以同时做几个相连的步骤
)
```

正如上面的例子，可以同时做几个相连的步骤，但是不建议跳步做，例如`"bi"`这样就不建议。因为这样执行，如果本底没变，那么`b`这一步完全没必要，如果变了，那么平场没有被对应生成，是不恰当的。通常来说，重做了前序步骤后，后序步骤也需要根据之前的结果重做。

但是也有一些特例，例如步骤`o`，由于测光步骤`p`中兼顾了找源和测光，而测定视场偏移必须依赖找源结果，因此`o`在`p`之后进行。但是一旦成功完成了，后续可以单独运行`p+c`，因为偏移量和测光本身无关。

### `obj=None, band=None`

目标和波段。这两个参数要么一起提供，要么一起不提供。如果只提供一个，那么将视为二者都不提供。

如果提供，那么将只处理该目标、该波段观测数据。如上面的例子，不提供`band`和`obj`，依赖于`l`步骤的结果，自动对全部数据都进行处理。

特别地，`band`可以为一个字符串或者列表、元组等，表示依次处理多个波段数据。`obj`也可以是列表或元组，表示处理多个目标的数据。

### `bandobj=None`

如果未提供`band`或`obj`，那么就根据本参数进行处理。用法参见前一节的例子。特别需要说明的是，如果`band`、`obj`、`bandobj`都未提供，步骤中也不包含`l`，程序将由于没有处理目标而直接退出。

### `base_img_id=0`

本参数对`o`和`c`步骤有效，用于指定图像列表中哪一幅为基准，默认为第一幅（从0开始编号）。在观测时，往往前几幅数据是测试性质，用于证认目标星、选定合适的曝光时间等，因为也具有科学价值，也会提供给用户，但是也可能质量并不好。本参数可以全序列中任意一幅作为基准。特别强调，文件名编号往往从0001开始，而这里的编号从0开始，所以如果指定10，那么对应图像是0011。

特别地，如果有同一台望远镜非当天的观测数据，也可以拿来作为基准。基准数据仅用于作为对齐基准，其中的测光信息不会被加入目标星表。此时，指定`base_img_id=-1`，并且必须指定`base_cat_file`和`base_fits_file`两个参数，前者为本系统生成的单幅星表，后者为图像本身（因为不作为科学数据，用原始图像或者平场本底改正后图像均可）。

### `base_cat_file=None, base_fits_file=None`

当指定`base_img_id=-1`时，必须同时指定这两个文件作为外部基准，否则程序将无法执行。如下面的例子：

```
base_dir="/home/data/"
qlcp21a.do_all(
    ini_file="xl60.ini", 
    raw_dir=base_dir+"raw/20210212_60/",
    lst_dir=base_dir+"lst/20210212_60/", 
    red_dir=base_dir+"red/20210212_60/",
    obj="J1836+3847",
    band="BVRI",
    base_img_id=-1,
    base_cat_file=base_dir+"red/20210211_60/J1836+3847_V/J1836+3847_V_0001.cat.fits",
    base_fits_file=base_dir+"red/20210211_60/J1836+3847_V/J1836+3847_V_0001.bf.fits",
    starxy=[(1020, 894), (1539, 274), (874, 1363)],
    steps="oc",
)
```

在上面的例子中，``starxy`提供的是在2月11日数据中的坐标。这样对于一个目标的观测，只需要选一张质量较好的历史数据标定目标位置即可。

### `starxy=None`

指定目标星，格式见上面的例子，为一个列表，列表的每个元素为一对x、y坐标。可以指定多颗源坐标。坐标精度要求不高，本程序将在指定坐标附近进行找源。

如果未给定该参数，那么本程序将自动调用`k`步骤，从数据中猜测目标星和参考星。

### `obj_coord=None`

本参数为一个二元元组，分别为赤经赤纬，用于指明目标的天球坐标，或者是图像中心的天球坐标。该参数用于将观测的JD转换为BJD，精度满足转换要求即可。例如：

`obj_coord=("18:36:56.34", "+38:47:01.3"),`

如果本参数未提供，那么将自动从fits文件头中找到天球坐标。

对于一个晚上观测了多个目标，而fits头中又不记录坐标的情况（典型案例：xl85），本参数可以提供一个字典Dict，关键字是目标名，值是RA/Dec对。例如：

```
obj_coord = {
    "Vega":("18:36:56.34", "+38:47:01.3"),
    "Sirius":("06:45:08.92","-16:42:58.0"),
},
```

### `tgt_id=0, ref_id=None, chk_id=None`

这一系列参数为步骤`d`使用，用于指定starxy中给出的一系列目标，哪一个是目标星，哪一组是参考星，哪一组是校验星。当`ref_id`或`chk_id`为空时，默认列表中除了目标星之外，都作为参考星和校验星。

本步骤建议手工逐步进行，即先只指定目标星，将所有猜测可用的星都作为参考星和校验星进行绘图，根据图中展示的数据情况，筛选最终的参考星和校验星。

### `overwrite=False`

本程序每个步骤都会检查本步骤的结果是否已经存在，如果发现该步骤已经执行过，那么将跳过本步骤。所以当需要对数据进行重新处理时，要么手工删除/改名原处理结果，要么设置本参数为`True`进行强制覆盖。

特别注意，对于`ip`两个步骤，是否跳过是逐个文件进行判断的。因此可能发生以下场景：在数据处理一半时，由于环境影响（如断电、内存不足、硬盘空间不足）或用户本人因素需要中断执行。当继续处理时，如果选用`overwrite=True`，将从头开始处理，而设置`overwrite=False`，将跳过已经处理的部分，从此前的断点位置继续开始。对于大规模数据处理，可以节省时间，并且方便中途打断。或者观测时的实时处理，合理利用本参数可以避免重复处理数据。

**以上参数为建议选用的参数，部分参数虽然可以缺省，但是仅限于简单情况。而以下参数则为高级参数，如果不确定用法，建议不设定，直接用默认值。**

### `noplot=False`

本程序默认为在notebook上输出图像，并且自动保存到文件中。如果在终端运行，建议设置本参数为`True`，只在后台画图并保存，不显示出来。

### `fig_set=None`

本参数用于指定绘图时的细节，本参数应该是一个字典，可选择的关键字及其默认值如下：

```
{
    "step_tgt_chk": None,  # 绘图时，在目标星和第一颗校验星之间距离多远（星等）
                    # 默认为目标星变幅标准差的2倍加上校验星变幅的5倍
    "step_chk_chk": None,  # 校验星之间的相互距离，默认为校验星变幅的5倍
    "marker_tgt": "rs",  # 目标星的颜色和图标
    "marker_chk": ("b*", "g*", "m*", "c*"),  # 校验星的颜色和图标，依次轮换
    "xlim": None,  # x轴范围，默认为自动选择
    "ylim": None,  # y轴范围，默认为自动选择的上下翻转
    "bjd_0": 0, # BJD零点，也就是横坐标减去一个固定数值，方便显示
    "figsize": (20, 10),  # 画布大小
}
```

### `extra_config=None`

对于配置文件中的配置项，如果需要临时进行修改，而不去改动配置文件时，可以使用本参数。本参数为字典，关键字和取值等参考下文中配置文件介绍。

## 附录A：调用示例

## 附录B：输出文件格式

## 附录C：配置文件项目
